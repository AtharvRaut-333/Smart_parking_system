pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:jdk17
    resources:
      limits:
        memory: "2Gi"
        cpu: "2"
      requests:
        memory: "1Gi"
        cpu: "1"
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"

  - name: dind
    image: docker:24-dind
    securityContext:
      privileged: true
    env:
      - name: DOCKER_TLS_CERTDIR
        value: ""
    resources:
      limits:
        memory: "4Gi"
        cpu: "2"
      requests:
        memory: "1Gi"
        cpu: "1"
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"

  - name: docker-cli
    image: docker:24-cli
    command:
    - cat
    tty: true
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"

  - name: node
    image: node:20-alpine
    command:
    - sleep
    args:
    - infinity
    resources:
      limits:
        memory: "1Gi"
        cpu: "1"
      requests:
        memory: "512Mi"
        cpu: "0.5"
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"

  volumes:
  - name: "workspace-volume"
    emptyDir: {}
"""
    }
  }

  tools {
    maven 'maven3'
    // SonarScanner must be configured in Jenkins Global Tool Configuration with this name
    // if you prefer a different name, change it here or in Jenkins global config
    // sonarScanner not required if you use maven sonar:sonar directly with -Dsonar.login
  }

  environment {
    NEXUS_DOCKER_REGISTRY = 'nexus.imcc.com:8082'
    NEXUS_CREDENTIALS_ID = 'nexus-credentials'   // username/password credential in Jenkins
    SONAR_HOST_URL = 'http://sonarqube.imcc.com'
    SONAR_CREDENTIALS_ID = 'sonarqube-token'     // secret text in Jenkins
    NEXUS_URL = 'http://nexus.imcc.com'
    NEXUS_REPOSITORY = 'maven-snapshots'
    BUILD_VERSION = "${env.BUILD_NUMBER}"
    APP_NAME = 'smart-parking-backend'
  }

  triggers { pollSCM('H/5 * * * *') }

  stages {

    stage('Checkout') {
      steps {
        echo "üì• Checking out code..."
        checkout scm
        script {
          env.GIT_COMMIT = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
        }
      }
    }

    stage('Build & Test') {
      parallel {

        stage('Backend Pipeline') {
          stages {
            stage('Backend: Build') {
              steps {
                dir('smark-parking-backend') {
                  sh 'mvn -B -DskipTests clean compile'
                }
              }
            }

            stage('Backend: SonarQube') {
              steps {
                dir('smark-parking-backend') {
                  withCredentials([string(credentialsId: SONAR_CREDENTIALS_ID, variable: 'SONAR_TOKEN')]) {
                    sh """
                      mvn -B sonar:sonar \
                        -Dsonar.projectKey=smart-parking-backend \
                        -Dsonar.projectName='Smart Parking Backend' \
                        -Dsonar.host.url=${SONAR_HOST_URL} \
                        -Dsonar.login=${SONAR_TOKEN}
                    """
                  }
                }
              }
            }

            stage('Backend: Package') {
              steps {
                dir('smark-parking-backend') {
                  sh 'mvn -B -DskipTests package'
                }
              }
            }

            stage('Backend: Deploy to Nexus') {
              steps {
                dir('smark-parking-backend') {
                  sh """
                    mvn -B deploy -DskipTests \
                      -DaltDeploymentRepository=nexus::default::${NEXUS_URL}/repository/${NEXUS_REPOSITORY}
                  """
                }
              }
            }

            stage('Backend: Build Docker Image') {
              steps {
                dir('smark-parking-backend') {
                  // use docker CLI inside docker-cli container (talks to dind via Docker socket)
                  container('docker-cli') {
                    sh """
                      # login handled in next stage; just build and tag locally
                      docker build -t ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:${BUILD_VERSION} .
                      docker tag ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:${BUILD_VERSION} ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:latest
                    """
                  }
                }
              }
            }

            stage('Backend: Push to Nexus') {
              steps {
                container('docker-cli') {
                  withCredentials([usernamePassword(credentialsId: NEXUS_CREDENTIALS_ID, usernameVariable: 'NEX_USR', passwordVariable: 'NEX_PSW')]) {
                    sh """
                      echo "$NEX_PSW" | docker login ${NEXUS_DOCKER_REGISTRY} -u "$NEX_USR" --password-stdin
                      docker push ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:${BUILD_VERSION}
                      docker push ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:latest
                    """
                  }
                }
              }
            }
          }
        } // end backend

        stage('Frontend Pipeline') {
          stages {
            stage('Frontend: Install') {
              steps {
                container('node') {
                  dir('smart-parking-frontend') {
                    sh 'npm ci'
                  }
                }
              }
            }

            stage('Frontend: Lint') {
              steps {
                container('node') {
                  dir('smart-parking-frontend') {
                    sh 'npm run lint || true'
                  }
                }
              }
            }

            stage('Frontend: Build') {
              steps {
                container('node') {
                  dir('smart-parking-frontend') {
                    sh 'CI=false npm run build'
                  }
                }
              }
            }

            stage('Frontend: SonarQube') {
              steps {
                dir('smart-parking-frontend') {
                  withCredentials([string(credentialsId: SONAR_CREDENTIALS_ID, variable: 'SONAR_TOKEN')]) {
                    sh """
                      # using sonar-scanner CLI if installed, otherwise use maven plugin for JS projects
                      sonar-scanner -Dsonar.projectKey=smart-parking-frontend \
                                    -Dsonar.projectName='Smart Parking Frontend' \
                                    -Dsonar.sources=src \
                                    -Dsonar.host.url=${SONAR_HOST_URL} \
                                    -Dsonar.login=${SONAR_TOKEN}
                    """
                  }
                }
              }
            }

            stage('Frontend: Build Docker Image') {
              steps {
                dir('smart-parking-frontend') {
                  container('docker-cli') {
                    sh """
                      docker build -t ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:${BUILD_VERSION} .
                      docker tag ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:${BUILD_VERSION} ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:latest
                    """
                  }
                }
              }
            }

            stage('Frontend: Push to Nexus') {
              steps {
                container('docker-cli') {
                  withCredentials([usernamePassword(credentialsId: NEXUS_CREDENTIALS_ID, usernameVariable: 'NEX_USR', passwordVariable: 'NEX_PSW')]) {
                    sh """
                      echo "$NEX_PSW" | docker login ${NEXUS_DOCKER_REGISTRY} -u "$NEX_USR" --password-stdin
                      docker push ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:${BUILD_VERSION}
                      docker push ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:latest
                    """
                  }
                }
              }
            }

          }
        } // end frontend
      } // end parallel
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Deploy Full Stack') {
      steps {
        // NOTE: This runs docker-compose on the Jenkins agent pod ‚Äî usually you want to deploy to a remote host.
        // If you want to deploy to remote EC2, replace this with an SSH step that runs docker-compose on the remote host.
        script {
          // Example SSH deploy (uncomment and configure if you prefer remote EC2):
          /*
          sshagent(['ec2-ssh-cred-id']) {
            sh "ssh -o StrictHostKeyChecking=no ubuntu@your-ec2-host 'docker pull ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:latest && docker pull ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:latest && docker-compose -f /path/docker-compose.yml up -d --remove-orphans'"
          }
          */
          // Quick local attempt (works only if docker-compose exists in the agent and the agent has Docker host access)
          container('docker-cli') {
            sh """
              docker pull ${NEXUS_DOCKER_REGISTRY}/smart-parking-backend:latest || true
              docker pull ${NEXUS_DOCKER_REGISTRY}/smart-parking-frontend:latest || true
              # If you have docker-compose binary inside the pod image, you can run it; otherwise use remote SSH deploy above
              # docker-compose up -d
            """
          }
        }
      }
    }

  } // end stages

  post {
    success {
      echo "üéâ Smart Parking ${BUILD_VERSION} deployed successfully!"
    }
    failure {
      echo "‚ùå Pipeline failed! Rolling back..."
      container('docker-cli') {
        sh "docker-compose down || true"
      }
    }
    always {
      echo "üßπ Done"
    }
  }

} // end pipeline
